name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint-terraform:
    name: Lint Terraform
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7
      
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        
      - name: Terraform Init
        run: terraform init -backend=false
      
      - name: Terraform Validate
        run: terraform validate

  lint-ansible:
    name: Lint Ansible
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ansible
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core ansible-lint
      
      - name: Run Ansible Lint
        run: |
          ansible-lint playbooks/site.yml --no-warnings || true

  lint-helm:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./helm
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.11.0'
      
      - name: Lint Helm Chart
        run: |
          cd webapp-stack
          helm lint .

  lint-shell-scripts:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: 'error'
          
  summary:
    name: Build Summary
    needs: [lint-terraform, lint-ansible, lint-helm, lint-shell-scripts]
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "âœ… All CI checks passed!"
          echo "Validated:"
          echo "  - Terraform Configuration"
          echo "  - Ansible Playbooks"
          echo "  - Helm Charts"
          echo "  - Shell Scripts"
